<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiceNow AI Copilot</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<!-- =====================================================
     LOGIN OVERLAY — shown until authenticated
     ===================================================== -->
<div id="loginOverlay" style="
    position:fixed;inset:0;z-index:9999;
    background:linear-gradient(135deg,#0d1b2a 0%,#1a2d4a 50%,#0d1b2a 100%);
    display:flex;align-items:center;justify-content:center;
">
    <div style="width:100%;max-width:460px;padding:1.5rem;">
        <!-- Logo -->
        <div class="text-center mb-4">
            <div style="
                width:72px;height:72px;border-radius:18px;
                background:linear-gradient(135deg,#0d6efd,#0a58ca);
                display:flex;align-items:center;justify-content:center;
                margin:0 auto 1rem;box-shadow:0 8px 24px rgba(13,110,253,.4);
            ">
                <i class="bi bi-robot text-white" style="font-size:2rem;"></i>
            </div>
            <h3 class="text-white fw-bold mb-1">ServiceNow AI Copilot</h3>
            <p class="text-white-50 small mb-0">Connect your ServiceNow instance to begin</p>
        </div>

        <!-- Login Card -->
        <div style="
            background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
            border-radius:16px;padding:2rem;backdrop-filter:blur(12px);
        ">
            <!-- Instance URL -->
            <div class="mb-3">
                <label class="text-white-50 small fw-semibold mb-1">
                    <i class="bi bi-globe me-1"></i>ServiceNow Instance URL
                </label>
                <div class="input-group">
                    <span class="input-group-text" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#adb5bd;">
                        https://
                    </span>
                    <input type="text" id="loginInstance" class="form-control login-input"
                        placeholder="your-instance.service-now.com"
                        style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#fff;">
                </div>
            </div>

            <!-- Username -->
            <div class="mb-3">
                <label class="text-white-50 small fw-semibold mb-1">
                    <i class="bi bi-person me-1"></i>Username
                </label>
                <input type="text" id="loginUsername" class="form-control login-input"
                    placeholder="admin"
                    style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#fff;">
            </div>

            <!-- Password -->
            <div class="mb-3">
                <label class="text-white-50 small fw-semibold mb-1">
                    <i class="bi bi-lock me-1"></i>Password
                </label>
                <div class="input-group">
                    <input type="password" id="loginPassword" class="form-control login-input"
                        placeholder="••••••••"
                        style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#fff;"
                        onkeypress="if(event.key==='Enter')doLogin()">
                    <button class="btn" id="togglePwd" type="button"
                        style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#adb5bd;"
                        onclick="togglePassword()">
                        <i class="bi bi-eye" id="togglePwdIcon"></i>
                    </button>
                </div>
            </div>

            <!-- Role -->
            <div class="mb-4">
                <label class="text-white-50 small fw-semibold mb-1">
                    <i class="bi bi-shield-check me-1"></i>Your Role
                </label>
                <select id="loginRole" class="form-select login-input"
                    style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:#fff;">
                    <option value="analyst" style="background:#1a2d4a;">Analyst — View &amp; run analysis</option>
                    <option value="admin" style="background:#1a2d4a;">Admin — Full access + push fixes</option>
                    <option value="readonly" style="background:#1a2d4a;">Read Only — View reports only</option>
                </select>
            </div>

            <!-- Error message -->
            <div id="loginError" class="alert alert-danger d-none mb-3" style="font-size:.85rem;padding:.6rem 1rem;border-radius:8px;"></div>

            <!-- Submit -->
            <button id="loginBtn" class="btn btn-primary w-100 fw-semibold py-2" onclick="doLogin()" style="border-radius:10px;font-size:1rem;">
                <span id="loginBtnText"><i class="bi bi-box-arrow-in-right me-2"></i>Connect &amp; Analyze</span>
                <span id="loginBtnSpinner" class="d-none">
                    <span class="spinner-border spinner-border-sm me-2"></span>Connecting…
                </span>
            </button>
        </div>

        <p class="text-center text-white-50 mt-3 small">
            <i class="bi bi-shield-lock me-1"></i>
            Credentials are encrypted in a server-side session and never stored permanently.
        </p>
    </div>
</div>

<!-- =====================================================
     MAIN APP — hidden until login
     ===================================================== -->
<div id="appWrapper" class="d-flex d-none" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-dark border-end" id="sidebar-wrapper">
        <div class="sidebar-heading text-white p-3 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <i class="bi bi-robot me-2 text-primary fs-5"></i>
                <span class="fw-bold">AI Copilot</span>
            </div>
        </div>

        <!-- Session info badge -->
        <div class="px-3 pb-2">
            <div id="sessionBadge" style="
                background:rgba(13,110,253,.15);border:1px solid rgba(13,110,253,.25);
                border-radius:8px;padding:.5rem .75rem;font-size:.75rem;
            ">
                <div class="text-white-50 mb-1"><i class="bi bi-globe me-1"></i><span id="sessionInstance" class="text-white fw-semibold"></span></div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-white-50"><i class="bi bi-person me-1"></i><span id="sessionUser"></span></span>
                    <span id="sessionRoleBadge" class="badge bg-primary" style="font-size:.65rem;"></span>
                </div>
            </div>
        </div>

        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action bg-primary text-white border-0 mb-1" onclick="newChat()">
                <i class="bi bi-plus-circle me-2"></i> New Chat
            </button>

            <div class="sidebar-section">
                <div class="sidebar-label">
                    <i class="bi bi-tools me-2"></i> SERVICENOW BUILDER
                </div>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('architecture')" data-agent="architecture">
                    <i class="bi bi-diagram-3 me-2"></i> Architecture
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('scripts')" data-agent="scripts">
                    <i class="bi bi-file-code me-2"></i> Scripts
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('performance')" data-agent="performance">
                    <i class="bi bi-speedometer2 me-2"></i> Performance
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('security')" data-agent="security">
                    <i class="bi bi-shield-lock me-2"></i> Security
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('integration')" data-agent="integration">
                    <i class="bi bi-plugin me-2"></i> Integration
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('data-health')" data-agent="data-health">
                    <i class="bi bi-heart-pulse me-2"></i> Data Health
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('upgrade')" data-agent="upgrade">
                    <i class="bi bi-arrow-up-circle me-2"></i> Upgrade
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callAgent('license-optimization')" data-agent="license-optimization">
                    <i class="bi bi-key me-2"></i> License Optimization
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="loadCFODashboard()">
                    <i class="bi bi-bar-chart-line me-2"></i> CFO Dashboard
                </button>
            </div>

            <div class="sidebar-section mt-2">
                <div class="sidebar-label">
                    <i class="bi bi-lightning me-2"></i> ACTIONS
                </div>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="callRunAll()">
                    <i class="bi bi-play-circle me-2"></i> Run All Agents
                </button>
                <button class="list-group-item list-group-item-action bg-dark text-white border-0" onclick="generateReport()">
                    <i class="bi bi-file-earmark-pdf me-2"></i> Generate Report
                </button>
            </div>

            <!-- Logout -->
            <div class="sidebar-section mt-2">
                <button class="list-group-item list-group-item-action bg-dark text-danger border-0" onclick="doLogout()">
                    <i class="bi bi-box-arrow-left me-2"></i> Disconnect / Logout
                </button>
            </div>
        </div>

        <div class="sidebar-footer text-white-50 p-3 small">
            <i class="bi bi-info-circle me-1"></i> ServiceNow AI Copilot v2.0
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper" class="w-100">
        <!-- Top Navigation -->
        <nav class="navbar navbar-light bg-white border-bottom shadow-sm">
            <div class="container-fluid">
                <button class="btn btn-link text-dark" id="sidebarToggle">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <span class="navbar-brand mb-0 h5 fw-bold">
                    <i class="bi bi-cloud text-primary me-2"></i>ServiceNow AI Copilot
                </span>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success" id="connectedBadge">
                        <i class="bi bi-circle-fill me-1" style="font-size:8px"></i> Connected
                    </span>
                    <div id="syncStatusBadge" class="sync-badge idle" title="Data sync status (every 10s)">
                        <i class="bi bi-arrow-repeat" id="syncIcon"></i>
                        <span id="syncLabel">Syncing…</span>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid p-4">

            <!-- Welcome Section -->
            <div id="welcomeSection">
                <div class="text-center mb-5 pt-3">
                    <div class="mb-3">
                        <i class="bi bi-robot display-3 text-primary"></i>
                    </div>
                    <h2 class="fw-bold">Welcome to ServiceNow AI Copilot</h2>
                    <p class="text-muted">Select an agent from the sidebar or click a card below to start analyzing your ServiceNow instance.</p>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm hover-card" onclick="callRunAll()" style="cursor:pointer">
                            <div class="card-body text-center p-4">
                                <div class="icon-circle bg-primary bg-opacity-10 mb-3 mx-auto">
                                    <i class="bi bi-tools fs-2 text-primary"></i>
                                </div>
                                <h5 class="fw-semibold">Run Analysis</h5>
                                <p class="text-muted small">Analyze all aspects of your ServiceNow instance with AI agents.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm hover-card" onclick="newChat()" style="cursor:pointer">
                            <div class="card-body text-center p-4">
                                <div class="icon-circle bg-success bg-opacity-10 mb-3 mx-auto">
                                    <i class="bi bi-chat-dots fs-2 text-success"></i>
                                </div>
                                <h5 class="fw-semibold">Interactive Chat</h5>
                                <p class="text-muted small">Ask questions and get AI-powered insights about your environment.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm hover-card" onclick="generateReport()" style="cursor:pointer">
                            <div class="card-body text-center p-4">
                                <div class="icon-circle bg-danger bg-opacity-10 mb-3 mx-auto">
                                    <i class="bi bi-file-earmark-pdf fs-2 text-danger"></i>
                                </div>
                                <h5 class="fw-semibold">Generate Reports</h5>
                                <p class="text-muted small">Download comprehensive PDF reports with all analysis results.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="text-muted fw-semibold mb-3"><i class="bi bi-grid me-2"></i>QUICK ACCESS</h6>
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm quick-card" onclick="callAgent('architecture')">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="quick-icon bg-primary bg-opacity-10 rounded-3 p-2">
                                    <i class="bi bi-diagram-3 text-primary fs-4"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold small">Architecture</div>
                                    <div class="text-muted" style="font-size:.75rem">Instance structure</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm quick-card" onclick="callAgent('security')">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="quick-icon bg-danger bg-opacity-10 rounded-3 p-2">
                                    <i class="bi bi-shield-lock text-danger fs-4"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold small">Security</div>
                                    <div class="text-muted" style="font-size:.75rem">ACL & risk audit</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm quick-card" onclick="callAgent('performance')">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="quick-icon bg-success bg-opacity-10 rounded-3 p-2">
                                    <i class="bi bi-speedometer2 text-success fs-4"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold small">Performance</div>
                                    <div class="text-muted" style="font-size:.75rem">Speed & logs</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm quick-card" onclick="callAgent('license-optimization')">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="quick-icon bg-warning bg-opacity-10 rounded-3 p-2">
                                    <i class="bi bi-key text-warning fs-4"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold small">Licenses</div>
                                    <div class="text-muted" style="font-size:.75rem">Cost optimization</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chatSection" class="chat-section d-none">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-chat-left-text me-2 text-primary"></i>AI Assistant</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                            <i class="bi bi-trash me-1"></i> Clear
                        </button>
                    </div>
                    <div class="card-body chat-container" id="chatMessages"></div>
                    <div class="card-footer bg-white border-top">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control"
                                placeholder="Ask about your ServiceNow instance..."
                                onkeypress="handleChatKeyPress(event)">
                            <button class="btn btn-primary px-4" onclick="sendChatMessage()">
                                <i class="bi bi-send me-1"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Output -->
            <div id="analysisSection" class="analysis-section d-none">
                <div id="agentHeader" class="mb-4"></div>

                <div id="loadingSpinner" class="d-none">
                    <div class="loading-bar-card card border-0 shadow-sm p-4 mb-4">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="loading-pulse-icon">
                                <i class="bi bi-robot fs-2 text-primary"></i>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold">AI Agent Running...</h5>
                                <p class="mb-0 text-muted small" id="loadingStatusText">Connecting to ServiceNow instance</p>
                            </div>
                        </div>
                        <div class="progress mb-3" style="height:8px;border-radius:8px;background:#e9ecef">
                            <div id="loadingProgressBar"
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 style="width:0%;border-radius:8px;transition:width 0.6s ease"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted" id="loadingPercent">0%</small>
                            <small class="text-muted" id="loadingStep">Step 1 of 4</small>
                        </div>
                        <div class="d-flex justify-content-between mt-4 gap-2">
                            <div class="loading-step-item active" id="step1">
                                <div class="loading-step-dot"></div>
                                <div class="loading-step-label">Connect</div>
                            </div>
                            <div class="loading-step-line flex-grow-1"></div>
                            <div class="loading-step-item" id="step2">
                                <div class="loading-step-dot"></div>
                                <div class="loading-step-label">Fetch Data</div>
                            </div>
                            <div class="loading-step-line flex-grow-1"></div>
                            <div class="loading-step-item" id="step3">
                                <div class="loading-step-dot"></div>
                                <div class="loading-step-label">AI Analysis</div>
                            </div>
                            <div class="loading-step-line flex-grow-1"></div>
                            <div class="loading-step-item" id="step4">
                                <div class="loading-step-dot"></div>
                                <div class="loading-step-label">Results</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="analysisOutput"></div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/app.js?v=10"></script>
</body>
</html>
